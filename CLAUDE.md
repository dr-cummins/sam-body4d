# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## CLI Command Rules

**One command at a time.** Never pipe (`|`), chain (`&&`, `||`, `;`), or redirect (`>`, `>>`) Bash commands together. The only exception is `$()` subshells for inline variable expansion (e.g. `$(grep HF_TOKEN .env.local | cut -d= -f2)` inside a curl argument is OK because it's a single command with an embedded value).

- Run each command as its own separate Bash tool call
- If you need to process command output (e.g. parse JSON, filter lines), use the Read tool on persisted output or use a dedicated tool (Grep, Glob) instead
- If a CLI command fails: **stop immediately**, diagnose the root cause, and implement a permanent fix (new rule, skill, or workflow) — do not retry the same broken approach
- Use `git -C /path` instead of `cd /path && git ...`

## Project Overview

SAM-Body4D is a training-free pipeline for temporally consistent 4D human mesh recovery from videos. It combines three pre-trained model families (SAM-3, SAM-3D-Body, Diffusion-VAS) orchestrated through a Gradio web UI and a headless batch script.

## Common Commands

```bash
# Run the Gradio web UI (port 7860)
python app.py

# Run batch/headless inference
python scripts/offline_app.py --input_video <path>

# Download checkpoints and generate config
python scripts/setup.py --ckpt-root /path/to/checkpoints

# Sync source files from main repo to hf-space
bash scripts/sync_to_hf.sh

# Check HF Space status (no pipes — outputs clean text)
python3 scripts/hf_space_info.py
python3 scripts/hf_space_info.py --poll 10 --interval 20

# Fetch HF Space logs (no pipes — handles SSE internally)
python3 scripts/hf_space_logs.py run --timeout 10 --lines 30
python3 scripts/hf_space_logs.py build --timeout 10 --lines 50
```

**Local Python environment** uses `uv` (see global rules), but the Docker/HF deployment uses `pip`.

There is no test suite, linter, or CI pipeline for this project.

## Architecture

### End-to-End Pipeline

```
Video → Frame Extraction → User Annotation (point clicks)
  → SAM-3 Mask Propagation (temporal segmentation)
  → Diffusion-VAS Occlusion Recovery (amodal seg + content completion + depth)
  → MoGe-2 FOV Estimation (camera intrinsics)
  → SAM-3D-Body Mesh Recovery (per-frame 3D meshes, batch size 64)
  → Kalman Temporal Smoothing
  → Mesh Rendering → MP4 Export
```

### Key Files

| File | Role |
|------|------|
| `app.py` | Main entry point. Gradio UI, model initialization, and full pipeline orchestration (~1180 lines). All pipeline stages are functions in this single file. |
| `scripts/offline_app.py` | Headless batch version of app.py. Auto-detects humans, runs full pipeline without GUI. |
| `configs/body4d.yaml` | OmegaConf config with all checkpoint paths and hyperparameters. Generated by `scripts/setup.py`. |
| `Dockerfile` | CUDA 12.1 + Python 3.11 container for HF Spaces. Runs as uid 1000, exposes port 7860. |

### Model Submodules (in `models/`)

| Submodule | Source | Purpose |
|-----------|--------|---------|
| `sam3/` | Facebook | Video object segmentation with temporal propagation |
| `sam_3d_body/` | Facebook | 3D human body mesh recovery (DINOv3 backbone) |
| `diffusion_vas/` | Kaihua-Chen | Amodal segmentation + content completion for occluded regions |

MoGe (Microsoft, FOV estimation) and Detectron2 (Facebook) are pip-installed from git.

### Utility Modules (in `utils/`)

| Module | Purpose |
|--------|---------|
| `mask_utils.py` | Mask filtering, resizing, bbox extraction, connected components |
| `painter.py` | Mask visualization, contour drawing, colormap overlays |
| `kalman.py` | Kalman filter for temporal smoothing of mesh parameters |
| `gpu_profiler.py` | `@gpu_profile` decorator for memory/timing instrumentation |
| `image2video.py` | Frame sequences to MP4 conversion |

### Runtime State

`app.py` uses a global `RUNTIME` dict for per-session state (video path, FPS, clicks, masks, targets) and global variables for loaded models (`sam3_model`, `sam3_3d_body_model`, `predictor`, `pipeline_mask`, `pipeline_rgb`, `depth_model`). Config is loaded via OmegaConf from `body4d.yaml`.

## Configuration

`configs/body4d.yaml` is the single runtime config file. It defines:
- `paths.ckpt_root` — base directory for all checkpoints
- Checkpoint paths for SAM-3, SAM-3D-Body (model + MHR + FOV estimator), Diffusion-VAS (amodal + completion + depth)
- `sam_3d_body.batch_size` (default 64)
- `completion.*` — detection/completion resolutions, max occlusion length

This file is generated by `scripts/setup.py` from a template. On HF Spaces, a pre-configured version lives in `hf-space/configs/body4d.yaml` with `ckpt_root: /data/checkpoints`.

## Deployment

### Dual-Repo Architecture

| Repo | Location | Remote | Purpose |
|------|----------|--------|---------|
| Main | `sam-body4d/` | `origin` → GitHub | Full source with LFS binaries |
| HF Space | `hf-space/` (sibling dir) | `origin` → HuggingFace | Text/source only, no binaries |

HuggingFace rejects binary files without git-xet. The `hf-space/` repo is a clean clone containing only text/source files. Use `git -C /path/to/hf-space` for all operations on it.

### HuggingFace Space Configuration

| Setting | Value |
|---------|-------|
| Space ID | `troutmoose/sam-body4d` |
| SDK | Docker |
| Hardware | L40S x1 (48GB VRAM) |
| Persistent Storage | Medium (150GB) mounted at `/data` |
| Dev Mode | Enabled (SSH access, live editing) |
| App Port | 7860 |
| URL | https://troutmoose-sam-body4d.hf.space |

### Container Environment

| Path | Purpose |
|------|---------|
| `/app` | Application code (WORKDIR) |
| `/data/checkpoints` | Model checkpoints (persistent across restarts) |
| `/data/.huggingface` | HF Hub cache (`HF_HOME`, persistent) |
| `/home/user` | User home directory (ephemeral) |

**Secrets** (set via HF Settings):
- `HF_TOKEN` — required for downloading gated models (SAM-3, SAM-3D-Body) at startup

### Startup Flow

1. Container starts, runs `start.py`
2. `start.py` checks if checkpoint sentinel files exist in `/data/checkpoints`
3. If missing, runs `scripts/setup.py --ckpt-root /data/checkpoints` to download all models (~20GB)
4. Once checkpoints are present, `start.py` exec's into `app.py`
5. `app.py` launches Gradio UI on port 7860

Checkpoints persist in `/data` across container restarts thanks to persistent storage. First boot takes ~20 min for downloads; subsequent boots skip straight to app launch.

### Deployment Workflow

1. Make changes in the main repo (`sam-body4d/`)
2. Run `bash scripts/sync_to_hf.sh` to copy source files to `hf-space/`
3. Manually update `hf-space/Dockerfile`, `hf-space/configs/body4d.yaml`, or `hf-space/start.py` if needed (these are NOT auto-synced)
4. Commit in `hf-space/` with `git -C /path/to/hf-space`
5. Use `/hf-deploy` skill to push and monitor, or `/hf-status` to check current state

### Helper Scripts

| Script | Purpose |
|--------|---------|
| `scripts/sync_to_hf.sh` | Rsync source files from main repo to hf-space, excluding binaries |
| `scripts/hf_space_info.py` | Query HF API, print clean status summary. Supports `--poll N --interval S` for monitoring builds |
| `scripts/hf_space_logs.py` | Fetch SSE log streams (build or run), print last N lines. Handles timeouts internally |
| `scripts/setup.py` | Download all model checkpoints from HF Hub and direct URLs |

### Skills

| Skill | Trigger | What it does |
|-------|---------|-------------|
| `/hf-status` | Check Space state | Runs `hf_space_info.py` + `hf_space_logs.py`, presents summary |
| `/hf-deploy` | Deploy to HF | Pre-flight git checks, `git push`, polls build with `hf_space_info.py --poll`, fetches logs |

Skills use `python3` helper scripts instead of raw `curl` to avoid piping and JSON parsing in the shell.

### Key Constraints

- **Never push binary files** (gif, mp4, png, jpg, pt, pth, safetensors) to the HF repo
- **Gated models**: SAM-3 and SAM-3D-Body require HF access approval before download
- **Dev Mode + pushes**: With Dev Mode enabled, pushes may not auto-trigger rebuilds. Use "Factory reboot" from HF Settings to force a rebuild.
- **HF token** is in `.env.local` as `HF_TOKEN`

## Dependencies

Python 3.12, PyTorch with CUDA, key packages: `gradio~=6.0`, `omegaconf`, `opencv-python`, `decord` (Linux-only wheels), `transformers`, `diffusers==0.29.1`, `pyrender`, `roma`, `einops`. Full list in `pyproject.toml`.

`decord` has no macOS ARM wheels — `uv run python` will fail on Apple Silicon. Use the Docker container or Linux for full pipeline execution.
